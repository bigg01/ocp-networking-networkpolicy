global
        #log /dev/log    local0
        #log /dev/log    local1 notice
        #chroot /var/lib/haproxy
        #stats socket /run/haproxy/admin.sock mode 660 level admin
        stats timeout 30s
        #user haproxy
        #group haproxy
        #daemon
        # Default SSL material locations
        #ca-base /etc/ssl/certs
        #crt-base /etc/ssl/private
        # Default ciphers to use on SSL-enabled listening sockets.
        # For more information, see ciphers(1SSL).
        #ssl-default-bind-ciphers kEECDH+aRSA+AES:kRSA+AES:+AES256:RC4-SHA:!kEDH:!LOW:!EXP:!MD5:!aNULL:!eNULL
defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
       
listen  stats   
        bind            *:1936
        mode            http
        log             global
        maxconn 10
            timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 3000
        stats enable
        stats hide-version
        stats refresh 30s
        stats show-node
        stats auth admin:password
        stats uri  /haproxy?stats



frontend localnodes
    bind *:8080
    mode http
    option  httplog
    acl whitelist src 10.0.0.4

        #use_backend not_in_acl if !whitelist
        use_backend nodes if whitelist
        default_backend not_in_acl
    


backend nodes
    mode http
    balance leastconn
    option forwardfor
    errorfile 503 ./503-mycustom.http
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-CLIENT-IP %[src]
    #option httpchk
    server idx2 localhost:4444 check 



backend not_in_acl
     log-tag DENIE
        option log-separate-errors
    mode http
    errorfile 403 ./403-mycustom.http
    http-request deny



backend not_in_acl_
        log-tag DENIE
        option log-separate-errors
        #tcp-request content use-service lua.hello_world
        errorfile      901      ./901-mycustom.http
        #tcp-request content reject






HTTP/1.0 403 Forbidden
Cache-Control: no-cache
Connection: close
Content-Type: text/html

<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SIX Forbidden</title>
  </head> 
  <body style="font-family:Arial,Helvetica,sans-serif;">
    <div style="margin: 0 auto; width: 960px;"> 
    <p>
    <img src="https://www.six-payment-services.com/etc/designs/sixwebv2/build/images/logos/logo2-six.min.svg" >

          <h1 >SIX Info - Forbidden</h1>
      </p>   
           <div class="cover"><h1>Access Denied <small>Error 403</small></h1><p class="lead">The requested resource requires IP whitelisting.</p></div>
    <footer><p>Technical Contact: <a href="mailto:x@example.com">x@example.com</a></p></footer>
    </div>
  </body> 
</html>
